name: ğŸš€ CI/CD Pipeline - Cinema App

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # DÃ©clenchement manuel

jobs:
  # Job unique simplifiÃ©
  ci-pipeline:
    name: ğŸ§ª CI Pipeline
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“‹ Validate Project Structure
        run: |
          echo "ğŸ” VÃ©rification de la structure..."
          
          # VÃ©rifier les dossiers principaux
          for dir in api-gateway auth-service cinema-service public-service frontend-app; do
            if [ -d "$dir" ]; then
              echo "âœ… $dir trouvÃ©"
            else
              echo "âŒ $dir manquant"
            fi
          done
          
          # VÃ©rifier docker-compose
          if [ -f "docker-compose.yml" ]; then
            echo "âœ… docker-compose.yml trouvÃ©"
          else
            echo "âŒ docker-compose.yml manquant"
          fi

      - name: ğŸ§ª Test Frontend Build
        run: |
          if [ -d "frontend-app" ] && [ -f "frontend-app/package.json" ]; then
            echo "ğŸ“¦ Test du frontend..."
            cd frontend-app
            npm install --no-audit --no-fund
            npm run build
            echo "âœ… Frontend build rÃ©ussi"
          else
            echo "âš ï¸ Frontend non trouvÃ©, skip"
          fi

      - name: ğŸ³ Test Docker Build (API Gateway)
        run: |
          if [ -f "api-gateway/Dockerfile" ]; then
            echo "ğŸ³ Test Docker build..."
            docker build -t test-api-gateway ./api-gateway
            echo "âœ… Docker build rÃ©ussi"
          else
            echo "âš ï¸ Dockerfile API Gateway non trouvÃ©"
          fi

      - name: ğŸ“Š Pipeline Summary
        run: |
          echo "ğŸ“Š RÃ‰SUMÃ‰ DU PIPELINE"
          echo "===================="
          echo "âœ… Structure validÃ©e"
          echo "âœ… Frontend testÃ©"
          echo "âœ… Docker testÃ©"
          echo "ğŸ‰ Pipeline terminÃ© avec succÃ¨s!" 