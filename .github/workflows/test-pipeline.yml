name: ğŸ§ª Test Pipeline - Cinema App

on:
  workflow_dispatch:  # Permet de dÃ©clencher manuellement
  push:
    branches: [ develop, feature/* ]

jobs:
  # Job 1: Validation basique
  validate:
    name: ğŸ“‹ Validate Project
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check project structure
        run: |
          echo "ğŸ” VÃ©rification de la structure du projet..."
          
          # VÃ©rifier que tous les services existent
          for service in api-gateway auth-service cinema-service public-service frontend-app; do
            if [ -d "$service" ]; then
              echo "âœ… $service exists"
              if [ -f "$service/package.json" ]; then
                echo "âœ… $service has package.json"
              else
                echo "âš ï¸ $service missing package.json"
              fi
              if [ -f "$service/Dockerfile" ]; then
                echo "âœ… $service has Dockerfile"
              else
                echo "âš ï¸ $service missing Dockerfile"
              fi
            else
              echo "âŒ $service directory not found"
              exit 1
            fi
          done
          
          # VÃ©rifier les fichiers de configuration
          if [ -f "docker-compose.yml" ]; then
            echo "âœ… docker-compose.yml exists"
          else
            echo "âŒ docker-compose.yml not found"
            exit 1
          fi
          
          echo "ğŸ‰ Structure validation completed!"

  # Job 2: Test Build Simple
  test-build:
    name: ğŸ—ï¸ Test Docker Build
    runs-on: ubuntu-latest
    needs: validate
    
    strategy:
      matrix:
        service: [api-gateway, frontend-app]  # Tester seulement 2 services critiques
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Test Docker build - ${{ matrix.service }}
        run: |
          echo "ğŸ³ Testing Docker build for ${{ matrix.service }}..."
          if [ -f "${{ matrix.service }}/Dockerfile" ]; then
            docker build -t test-${{ matrix.service }}:latest ./${{ matrix.service }}
            echo "âœ… Docker build successful for ${{ matrix.service }}!"
          else
            echo "âš ï¸ No Dockerfile found for ${{ matrix.service }}"
          fi

  # Job 3: Test Dependencies
  test-deps:
    name: ğŸ“¦ Test Dependencies
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ§ª Test Frontend Dependencies
        working-directory: ./frontend-app
        run: |
          if [ -f "package.json" ]; then
            echo "ğŸ“¦ Testing frontend dependencies..."
            npm install
            echo "âœ… Frontend dependencies OK"
          else
            echo "âš ï¸ No frontend package.json found"
          fi

      - name: ğŸ§ª Test API Gateway Dependencies
        working-directory: ./api-gateway
        run: |
          if [ -f "package.json" ]; then
            echo "ğŸ“¦ Testing API Gateway dependencies..."
            npm install
            echo "âœ… API Gateway dependencies OK"
          else
            echo "âš ï¸ No API Gateway package.json found"
          fi

  # Job 4: Rapport final
  test-report:
    name: ğŸ“Š Test Report
    runs-on: ubuntu-latest
    needs: [validate, test-build, test-deps]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Test Report
        run: |
          echo "ğŸ“Š RAPPORT DE TEST SIMPLIFIÃ‰"
          echo "============================"
          echo ""
          
          if [[ "${{ needs.validate.result }}" == "success" ]]; then
            echo "âœ… Project validation: PASSED"
          else
            echo "âŒ Project validation: FAILED"
          fi
          
          if [[ "${{ needs.test-build.result }}" == "success" ]]; then
            echo "âœ… Docker build tests: PASSED"
          else
            echo "âŒ Docker build tests: FAILED"
          fi
          
          if [[ "${{ needs.test-deps.result }}" == "success" ]]; then
            echo "âœ… Dependencies tests: PASSED"
          else
            echo "âŒ Dependencies tests: FAILED"
          fi
          
          echo ""
          echo "ğŸ¯ Tests terminÃ©s Ã  $(date)"
          
          # Compter les succÃ¨s
          success_count=0
          if [[ "${{ needs.validate.result }}" == "success" ]]; then
            ((success_count++))
          fi
          if [[ "${{ needs.test-build.result }}" == "success" ]]; then
            ((success_count++))
          fi
          if [[ "${{ needs.test-deps.result }}" == "success" ]]; then
            ((success_count++))
          fi
          
          echo "ğŸ“ˆ Score: $success_count/3 tests rÃ©ussis"
          
          if [[ $success_count -eq 3 ]]; then
            echo "ğŸ‰ Tous les tests sont rÃ©ussis!"
          elif [[ $success_count -ge 2 ]]; then
            echo "âš ï¸ Tests majoritairement rÃ©ussis"
          else
            echo "ğŸ’¥ Ã‰chec critique des tests"
            exit 1
          fi 