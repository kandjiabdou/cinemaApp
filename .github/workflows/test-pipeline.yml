name: ğŸ§ª Test Pipeline - Cinema App

on:
  workflow_dispatch:  # Permet de dÃ©clencher manuellement
  push:
    branches: [ develop, feature/* ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job 1: Validation basique des services
  validate-structure:
    name: ğŸ“‹ Validate Project Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check project structure
        run: |
          echo "ğŸ” VÃ©rification de la structure du projet..."
          
          # VÃ©rifier que tous les services existent
          for service in api-gateway auth-service cinema-service public-service frontend-app; do
            if [ -d "$service" ]; then
              echo "âœ… $service exists"
              if [ -f "$service/package.json" ]; then
                echo "âœ… $service has package.json"
              else
                echo "âš ï¸  $service missing package.json"
              fi
              if [ -f "$service/Dockerfile" ]; then
                echo "âœ… $service has Dockerfile"
              else
                echo "âš ï¸  $service missing Dockerfile"
              fi
            else
              echo "âŒ $service directory not found"
              exit 1
            fi
          done
          
          # VÃ©rifier les fichiers de configuration
          if [ -f "docker-compose.yml" ]; then
            echo "âœ… docker-compose.yml exists"
          else
            echo "âŒ docker-compose.yml not found"
            exit 1
          fi
          
          echo "ğŸ‰ Structure validation completed!"

  # Job 2: Test de build simple pour un service
  test-build-single:
    name: ğŸ—ï¸ Test Build (API Gateway)
    runs-on: ubuntu-latest
    needs: validate-structure
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Install dependencies
        working-directory: ./api-gateway
        run: |
          if [ -f "package.json" ]; then
            npm ci
            echo "âœ… Dependencies installed"
          else
            echo "âš ï¸  No package.json found, skipping npm install"
          fi

      - name: ğŸ³ Test Docker build
        run: |
          echo "ğŸ³ Testing Docker build for api-gateway..."
          docker build -t test-api-gateway:latest ./api-gateway
          echo "âœ… Docker build successful!"

      - name: ğŸ§ª Test container run
        run: |
          echo "ğŸ§ª Testing container startup..."
          
          # DÃ©marrer le container en arriÃ¨re-plan
          docker run -d --name test-api-gateway -p 3333:3000 \
            -e NODE_ENV=test \
            test-api-gateway:latest
          
          # Attendre un peu
          sleep 10
          
          # VÃ©rifier que le container fonctionne
          if docker ps | grep test-api-gateway; then
            echo "âœ… Container is running"
          else
            echo "âŒ Container failed to start"
            docker logs test-api-gateway
            exit 1
          fi
          
          # Nettoyer
          docker stop test-api-gateway
          docker rm test-api-gateway

  # Job 3: Test du workflow Prometheus/Grafana
  test-monitoring:
    name: ğŸ“Š Test Monitoring Stack
    runs-on: ubuntu-latest
    needs: validate-structure
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check monitoring configuration
        run: |
          echo "ğŸ” VÃ©rification de la configuration monitoring..."
          
          if [ -d "prometheus" ]; then
            echo "âœ… Prometheus directory exists"
            if [ -f "prometheus/prometheus.yml" ]; then
              echo "âœ… Prometheus config exists"
            else
              echo "âš ï¸  Prometheus config missing"
            fi
          fi
          
          if [ -d "grafana" ]; then
            echo "âœ… Grafana directory exists"
          fi

      - name: ğŸš€ Test monitoring with Docker Compose
        run: |
          echo "ğŸš€ DÃ©marrage des services de monitoring..."
          
          # DÃ©marrer seulement Prometheus et Grafana
          docker-compose up -d prometheus grafana postgres
          
          # Attendre que les services soient prÃªts
          sleep 30
          
          # Tester Prometheus
          if curl -f http://localhost:9090/-/healthy; then
            echo "âœ… Prometheus is healthy"
          else
            echo "âš ï¸  Prometheus health check failed"
          fi
          
          # Tester Grafana
          if curl -f http://localhost:3009; then
            echo "âœ… Grafana is responding"
          else
            echo "âš ï¸  Grafana not responding"
          fi

      - name: ğŸ§¹ Cleanup monitoring test
        if: always()
        run: |
          docker-compose down -v
          docker system prune -f

  # Job 4: Test basique de la base de donnÃ©es
  test-database:
    name: ğŸ—„ï¸ Test Database Setup
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: cinema_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Install shared dependencies
        working-directory: ./shared
        run: |
          if [ -f "package.json" ]; then
            npm ci
            echo "âœ… Shared dependencies installed"
          else
            echo "âš ï¸  No shared package.json found"
          fi

      - name: ğŸ—„ï¸ Test database initialization
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: cinema_db
          DB_USER: postgres
          DB_PASSWORD: postgres
        run: |
          echo "ğŸ—„ï¸ Testing database initialization..."
          
          # Attendre que PostgreSQL soit prÃªt
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          
          # Tester la connexion
          PGPASSWORD=postgres psql -h localhost -U postgres -d cinema_db -c "SELECT version();"
          
          # Initialiser la base si init.sql existe
          if [ -f "init.sql" ]; then
            echo "ğŸ“‹ Running init.sql..."
            PGPASSWORD=postgres psql -h localhost -U postgres -d cinema_db -f init.sql
            echo "âœ… Database initialized"
          fi

      - name: ğŸ§ª Test migration script
        working-directory: ./shared
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: cinema_db
          DB_USER: postgres
          DB_PASSWORD: postgres
        run: |
          if [ -f "migrate_all.js" ]; then
            echo "ğŸ”„ Testing migration script..."
            npm run migrate:all
            echo "âœ… Migration successful"
          else
            echo "âš ï¸  No migration script found"
          fi

  # Job 5: Rapport de test
  test-report:
    name: ğŸ“Š Test Report
    runs-on: ubuntu-latest
    needs: [validate-structure, test-build-single, test-monitoring, test-database]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Test Report
        run: |
          echo "ğŸ“Š RAPPORT DE TEST CI/CD"
          echo "========================"
          echo ""
          
          if [[ "${{ needs.validate-structure.result }}" == "success" ]]; then
            echo "âœ… Structure validation: PASSED"
          else
            echo "âŒ Structure validation: FAILED"
          fi
          
          if [[ "${{ needs.test-build-single.result }}" == "success" ]]; then
            echo "âœ… Docker build test: PASSED"
          else
            echo "âŒ Docker build test: FAILED"
          fi
          
          if [[ "${{ needs.test-monitoring.result }}" == "success" ]]; then
            echo "âœ… Monitoring test: PASSED"
          else
            echo "âŒ Monitoring test: FAILED"
          fi
          
          if [[ "${{ needs.test-database.result }}" == "success" ]]; then
            echo "âœ… Database test: PASSED"
          else
            echo "âŒ Database test: FAILED"
          fi
          
          echo ""
          echo "ğŸ¯ Tests terminÃ©s Ã  $(date)"
          
          # Ã‰chouer si un test critique a Ã©chouÃ©
          if [[ "${{ needs.validate-structure.result }}" != "success" ]]; then
            echo "ğŸ’¥ Ã‰chec critique: structure du projet invalide"
            exit 1
          fi 